# test_flow.py
"""
Script para probar el flujo completo del agente de leads
Ejecutar: python test_flow.py
"""

import asyncio
import httpx
import time
from datetime import datetime

# Configuraci√≥n
API_BASE_URL = "http://localhost:8000"
TEST_PHONE = "+593997814126"
TEST_USER_ID = "user_001"

class LeadsAgentTester:
    def __init__(self):
        self.base_url = API_BASE_URL
        
    async def test_complete_flow(self):
        """Prueba el flujo completo del sistema"""
        print("üöÄ Iniciando test del flujo completo del Agente de Leads")
        print("=" * 60)
        
        async with httpx.AsyncClient(timeout=30.0) as client:
            # 1. Health Check
            await self.test_health_check(client)
            
            # 2. Verificar estado inicial
            await self.test_initial_state(client)
            
            # 3. Simular eventos de usuario
            await self.test_event_simulation(client)
            
            # 4. Iniciar monitoreo de reglas
            await self.test_rules_monitoring(client)
            
            # 5. Verificar activaciones
            await self.test_activation_check(client)
            
            # 6. Simular mensaje de WhatsApp
            await self.test_whatsapp_webhook(client)
            
            # 7. Verificar resultados
            await self.test_results_verification(client)
            
            # Nuevo test para fallback/clarify
            await self.test_fallback_clarify(client)
            
        print("\n‚úÖ Test completo finalizado!")
    
    async def test_health_check(self, client: httpx.AsyncClient):
        """Test 1: Verificar que la API est√© funcionando"""
        print("\n1Ô∏è‚É£ Testing Health Check...")
        
        try:
            response = await client.get(f"{self.base_url}/health")
            if response.status_code == 200:
                data = response.json()
                print(f"   ‚úÖ API Health: {data['status']}")
                print(f"   üìä Database: {data['components']['database']['status']}")
                print(f"   ü§ñ OpenAI: {data['components']['openai']['status']}")
            else:
                print(f"   ‚ùå Health check failed: {response.status_code}")
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
    
    async def test_initial_state(self, client: httpx.AsyncClient):
        """Test 2: Verificar estado inicial del sistema"""
        print("\n2Ô∏è‚É£ Testing Initial State...")
        
        try:
            # Verificar estado del motor de reglas
            response = await client.get(f"{self.base_url}/rules/monitoring-status")
            if response.status_code == 200:
                data = response.json()
                print(f"   üì° Rules Engine: {'Running' if data['is_running'] else 'Stopped'}")
            
            # Verificar eventos recientes
            response = await client.get(f"{self.base_url}/rules/recent-events?minutes_ago=10")
            if response.status_code == 200:
                data = response.json()
                print(f"   üìä Recent Events: {data['count']} eventos en √∫ltimos 10 min")
            
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
    
    async def test_event_simulation(self, client: httpx.AsyncClient):
        """Test 3: Simular eventos de usuario"""
        print("\n3Ô∏è‚É£ Testing Event Simulation...")
        
        try:
            # Simular m√∫ltiples logins (deber√≠a activar regla de frecuencia)
            response = await client.post(
                f"{self.base_url}/rules/simulate-events",
                json={
                    "user_id": TEST_USER_ID,
                    "behavior_type": "high_activity"
                }
            )
            
            if response.status_code == 200:
                print("   ‚úÖ Simulados eventos de alta actividad")
            
            # Esperar un poco
            await asyncio.sleep(2)
            
            # Simular inter√©s en cr√©dito
            response = await client.post(
                f"{self.base_url}/rules/simulate-events",
                json={
                    "user_id": TEST_USER_ID,
                    "behavior_type": "credit_interest"
                }
            )
            
            if response.status_code == 200:
                print("   ‚úÖ Simulados eventos de inter√©s en cr√©dito")
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
    
    async def test_rules_monitoring(self, client: httpx.AsyncClient):
        """Test 4: Iniciar y probar monitoreo de reglas"""
        print("\n4Ô∏è‚É£ Testing Rules Monitoring...")
        
        try:
            # Iniciar monitoreo
            response = await client.post(
                f"{self.base_url}/rules/start-monitoring",
                params={"interval_seconds": 5}  # Cada 5 segundos para testing r√°pido
            )
            
            if response.status_code == 200:
                print("   ‚úÖ Monitoreo de reglas iniciado (cada 5 segundos)")
            
            # Procesar eventos manualmente una vez
            response = await client.post(f"{self.base_url}/rules/process-events")
            if response.status_code == 200:
                print("   ‚úÖ Procesamiento manual de eventos ejecutado")
            
            # Esperar que el monitoreo autom√°tico procese
            print("   ‚è≥ Esperando procesamiento autom√°tico...")
            await asyncio.sleep(8)
            
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
    
    async def test_activation_check(self, client: httpx.AsyncClient):
        """Test 5: Verificar si se activaron reglas"""
        print("\n5Ô∏è‚É£ Testing Rule Activations...")
        
        try:
            # Verificar eventos recientes nuevamente
            response = await client.get(f"{self.base_url}/rules/recent-events?minutes_ago=5")
            if response.status_code == 200:
                data = response.json()
                print(f"   üìä Eventos recientes: {data['count']}")
                
                if data['events']:
                    latest_event = data['events'][0]
                    print(f"   üìù √öltimo evento: {latest_event['event_type']} para {latest_event['user_id']}")
            
            # Verificar si hay alguna campa√±a con reglas
            # Primero necesitamos encontrar un campaign_id
            # Para simplicidad, usaremos un ID gen√©rico en el test
            
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
    
    async def test_whatsapp_webhook(self, client: httpx.AsyncClient):
        """Test 6: Simular mensaje de WhatsApp entrante"""
        print("\n6Ô∏è‚É£ Testing WhatsApp Webhook...")
        
        try:
            # Simular mensaje de WhatsApp
            response = await client.post(
                f"{self.base_url}/webhook/builderbot",
                json={
                    "phone": TEST_PHONE,
                    "message": "Hola, me interesa informaci√≥n sobre cr√©ditos",
                    "ref": "test_ref",
                    "keyword": None
                }
            )
            
            if response.status_code == 200:
                data = response.json()
                print(f"   ‚úÖ Webhook procesado: {data['status']}")
                print(f"   üí¨ Respuesta: {data['response'][:100]}...")
                print(f"   üîÑ Paso actual: {data['step']}")
            else:
                print(f"   ‚ö†Ô∏è Webhook response: {response.status_code}")
                if response.status_code == 200:
                    print(f"   üìù Response: {response.json()}")
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
    
    async def test_results_verification(self, client: httpx.AsyncClient):
        """Test 7: Verificar resultados finales"""
        print("\n7Ô∏è‚É£ Testing Results Verification...")
        
        try:
            # Detener monitoreo
            response = await client.post(f"{self.base_url}/rules/stop-monitoring")
            if response.status_code == 200:
                print("   ‚èπÔ∏è Monitoreo detenido")
            
            # Verificar estado final
            response = await client.get(f"{self.base_url}/rules/monitoring-status")
            if response.status_code == 200:
                data = response.json()
                print(f"   üì° Estado final: {'Running' if data['is_running'] else 'Stopped'}")
            
            # Mostrar resumen
            print("\nüìã RESUMEN DEL TEST:")
            print("   ‚úÖ Sistema iniciado correctamente")
            print("   ‚úÖ Eventos simulados")
            print("   ‚úÖ Motor de reglas funcionando")
            print("   ‚úÖ Webhook de WhatsApp operativo")
            print("   ‚úÖ Agente conversacional respondiendo")
                
        except Exception as e:
            print(f"   ‚ùå Error: {e}")

    async def test_fallback_clarify(self, client: httpx.AsyncClient):
        """Test: Simular mensaje confuso y esperar aclaraci√≥n"""
        print("\n8Ô∏è‚É£ Testing Fallback/Clarify...")
        try:
            response = await client.post(
                f"{self.base_url}/webhook/builderbot",
                json={
                    "phone": TEST_PHONE,
                    "message": "asdfghjkl",  # Mensaje confuso
                    "ref": "test_ref",
                    "keyword": None
                }
            )
            if response.status_code == 200:
                data = response.json()
                print(f"   üü¢ Fallback/Clarify procesado: {data['status']}")
                print(f"   üí¨ Respuesta: {data['response'][:100]}...")
                print(f"   üîÑ Paso actual: {data['step']}")
            else:
                print(f"   ‚ö†Ô∏è Fallback/Clarify response: {response.status_code}")
        except Exception as e:
            print(f"   ‚ùå Error: {e}")

async def main():
    """Funci√≥n principal"""
    tester = LeadsAgentTester()
    await tester.test_complete_flow()

if __name__ == "__main__":
    print("üß™ Tester del Agente de Leads")
    print(f"üîó API URL: {API_BASE_URL}")
    print(f"üì± Test Phone: {TEST_PHONE}")
    print(f"üë§ Test User: {TEST_USER_ID}")
    print(f"‚è∞ Timestamp: {datetime.now()}")
    
    asyncio.run(main())